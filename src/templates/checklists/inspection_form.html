<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞: {{ inspection.template.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* –î–µ–ª–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –±–æ–ª—å—à–∏–º–∏ –∏ —É–¥–æ–±–Ω—ã–º–∏ –¥–ª—è –ø–∞–ª—å—Ü–µ–≤ */
        .btn-check-group {
            display: flex;
            width: 100%;
        }

        .btn-check-group input {
            display: none;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ */

        .btn-check-group label {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ced4da;
            cursor: pointer;
            user-select: none;
        }

        /* –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ (–î–∞) */
        .lbl-yes {
            border-radius: 5px 0 0 5px;
            background: #f8f9fa;
            color: #198754;
        }

        input[value="true"]:checked + label.lbl-yes {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }

        /* –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ (–ù–µ—Ç) */
        .lbl-no {
            border-radius: 0 5px 5px 0;
            background: #f8f9fa;
            color: #dc3545;
        }

        input[value="false"]:checked + label.lbl-no {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dee2e6;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        body {
            padding-bottom: 80px;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .disabled-state {
            opacity: 0.5;           /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            pointer-events: none;   /* –ó–∞–ø—Ä–µ—Ç –∫–ª–∏–∫–æ–≤ */
            cursor: not-allowed;
        }

        /* –ö—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç */
        textarea:required {
            border-left: 4px solid #dc3545;
        }

        /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ —Ñ—É—Ç–µ—Ä */
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <!-- –®–∞–ø–∫–∞ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="text-muted mb-0">–ß–µ–∫-–ª–∏—Å—Ç ‚Ññ{{ inspection.id }}</h5>
            <h2 class="mb-0">{{ inspection.template.name }}</h2>
            <p class="text-muted">{{ inspection.location_snapshot }} | {{ inspection.date_check
                }}</p>
        </div>
        <a href="{% url 'employee_dashboard' %}" class="btn btn-outline-secondary">‚úï –ó–∞–∫—Ä—ã—Ç—å</a>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
    <!-- –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª–µ–Ω enctype -->
    <form method="post" id="inspectionForm" enctype="multipart/form-data">
        {% csrf_token %}

        {% for section_name, items in sections_data.items %}
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white fw-bold py-3 text-primary border-bottom-0">
                {{ section_name }}
            </div>
            <div class="card-body p-0">
                {% for item in items %}
                <div class="p-3 border-top {% if not forloop.first %}border-top{% endif %}">
                    <div class="mb-2 fw-medium">
                        {{ item.criteria_text }}
                    </div>

                    <!-- –ë–õ–û–ö –ü–û–í–¢–û–†–ù–û–ì–û –ù–ê–†–£–®–ï–ù–ò–Ø -->
                    {% if item.history %}
                        <div class="mb-3">
                            <!-- –ö–Ω–æ–ø–∫–∞-–∑–∞–≥–æ–ª–æ–≤–æ–∫ (–°–≤–µ—Ä–Ω—É—Ç–∞—è) -->
                            <button type="button"
                                    class="btn btn-warning btn-sm w-100 text-start d-flex justify-content-between align-items-center"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#history-{{ item.id }}"
                                    aria-expanded="false"
                                    style="background-color: #fff3cd; border-color: #ffecb5; color: #664d03;">
                                <span>
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    –ë—ã–ª–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ ({{ item.history.inspection.date_check|date:"d.m.Y" }})
                                </span>
                                <i class="bi bi-chevron-down"></i>
                            </button>

                            <!-- –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
                            <div class="collapse" id="history-{{ item.id }}">
                                <div class="card card-body border-warning border-top-0 rounded-0 rounded-bottom bg-light p-2">

                                    <!-- –°—Ç–∞—Ä—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                                    <div class="small mb-2 fst-italic text-muted border-start border-3 border-warning ps-2">
                                        "{{ item.history.comment|default:"–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è" }}"
                                    </div>

                                    <!-- –°—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                                    {% if item.history.photos.all %}
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for photo in item.history.photos.all %}
                                                <a href="{{ photo.image.url }}" target="_blank">
                                                    <!-- object-fit: cover –æ–±—Ä–µ–∑–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ —Ü–µ–Ω—Ç—Ä–∞ -->
                                                    <img src="{{ photo.image.url }}"
                                                         style="width: 150px; height: 150px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc;"
                                                         class="shadow-sm">
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    <!-- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ò–°–¢–û–†–ò–ò -->

                    <div class="row g-2">
                        <!-- –ë–ª–æ–∫ 1: –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ -->
                        <div class="col-12 col-md-4">
                            <div class="btn-check-group">

                                <!-- –ö–Ω–æ–ø–∫–∞ –û–ö -->
                                <!-- –í—ã–±—Ä–∞–Ω–∞, –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ò –Ω–µ—Ç —Ñ–æ—Ç–æ -->
                                <input type="radio" name="compliant_{{ item.id }}"
                                       id="radio_ok_{{ item.id }}" value="true"
                                       {% if not item.comment and not item.photos.all %}checked{% endif %}
                                       disabled> <!-- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é disabled, JS —Å–∞–º —Ä–µ—à–∏—Ç, –º–æ–∂–Ω–æ –ª–∏ –≤–∫–ª—é—á–∏—Ç—å -->
                                <label for="radio_ok_{{ item.id }}" class="lbl-yes" id="label_ok_{{ item.id }}">‚úî –û–ö</label>

                                <!-- –ö–Ω–æ–ø–∫–∞ –ù–∞—Ä—É—à–µ–Ω–∏–µ -->
                                <!-- –í—ã–±—Ä–∞–Ω–∞, –µ—Å–ª–∏ –ï–°–¢–¨ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ò–õ–ò –µ—Å—Ç—å —Ñ–æ—Ç–æ -->
                                <input type="radio" name="compliant_{{ item.id }}"
                                       id="radio_bad_{{ item.id }}" value="false"
                                       {% if item.comment or item.photos.all %}checked{% endif %}>
                                <label for="radio_bad_{{ item.id }}" class="lbl-no">‚úñ –ù–∞—Ä—É—à–µ–Ω–∏–µ</label>
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ 2: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –§–æ—Ç–æ -->
                        <div class="col-12 col-md-8">
                            <!-- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ -->
                            <textarea name="comment_{{ item.id }}" id="comment_{{ item.id }}"
                                      class="form-control mb-2" rows="1"
                                      placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ..."
                                      oninput="updateItemState({{ item.id }})">{{ item.comment }}</textarea>

                            <div class="mt-2">
                                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª–∏–Ω—É –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞) -->
                                <div class="d-flex flex-wrap gap-2 mb-2" id="photo-container-{{ item.id }}">
                                    {% for photo in item.photos.all %}
                                        <div class="position-relative photo-wrapper" id="photo-wrapper-{{ photo.id }}">
                                            <a href="{{ photo.image.url }}" target="_blank">
                                                <img src="{{ photo.image.url }}" style="height: 80px; width: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd;">
                                            </a>
                                            <button type="button"
                                                    class="btn position-absolute top-0 end-0 m-1 p-0 border-0 bg-transparent"
                                                    onclick="deletePhoto({{ photo.id }}, {{ item.id }})"> <!-- –ü–µ—Ä–µ–¥–∞–µ–º item.id! -->
                                                <i class="bi bi-trash-fill text-danger" style="font-size: 18px; text-shadow: 0 0 3px rgba(255,255,255, 0.9);"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
                                <!-- id="photo_btn_..." –Ω—É–∂–µ–Ω –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -->
                                <div id="photo_btn_{{ item.id }}">
                                    <label class="btn btn-sm btn-outline-primary">
                                        üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                                        <input type="file" style="display: none;" multiple accept="image/*"
                                               onchange="uploadPhoto(this, {{ item.id }})">
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- –§—É—Ç–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ –æ—Å—Ç–∞–ª—Å—è —Ç–µ–º –∂–µ -->
        <div class="sticky-footer d-flex gap-2 justify-content-end">
            <button type="submit" name="action" value="save" class="btn btn-secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button type="submit" name="action" value="complete"
                    class="btn btn-success fw-bold px-4"
                    onclick="return confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É?');">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </div>
    </form>
</div>
<!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í BOOTSTRAP (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω (–Ω—É–∂–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');


   // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –õ–û–ì–ò–ö–ò ===
    function updateItemState(itemId) {
        // 1. –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        const radioOk = document.getElementById(`radio_ok_${itemId}`);
        const labelOk = document.getElementById(`label_ok_${itemId}`);
        const radioBad = document.getElementById(`radio_bad_${itemId}`);

        const commentField = document.getElementById(`comment_${itemId}`);
        const photoContainer = document.getElementById(`photo-container-${itemId}`);

        // 2. –°—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        const photoCount = photoContainer.children.length;
        const commentText = commentField.value.trim();
        const hasData = (photoCount > 0 || commentText.length > 0);

        // --- –õ–û–ì–ò–ö–ê 1: –ê–í–¢–û-–ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê ---
        if (hasData) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ -> –≠—Ç–æ –ù–∞—Ä—É—à–µ–Ω–∏–µ
            radioBad.checked = true;

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –û–ö (–Ω–µ–ª—å–∑—è –Ω–∞–∂–∞—Ç—å –û–ö, –ø–æ–∫–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
            radioOk.disabled = true;
            labelOk.classList.add('disabled-state');
        } else {
            // –ï—Å–ª–∏ –≤—Å–µ —á–∏—Å—Ç–æ -> –≠—Ç–æ –û–ö
            radioOk.checked = true;

            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –û–ö (—Ö–æ—Ç—è –æ–Ω–∞ –∏ —Ç–∞–∫ –Ω–∞–∂–∞—Ç–∞)
            radioOk.disabled = false;
            labelOk.classList.remove('disabled-state');
        }

        // --- –õ–û–ì–ò–ö–ê 2: –í–ê–õ–ò–î–ê–¶–ò–Ø (–§–û–¢–û –¢–†–ï–ë–£–ï–¢ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø) ---
        if (photoCount > 0) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù
            commentField.required = true;
            commentField.placeholder = "–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ñ–æ—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!";

            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç
            if (commentText.length === 0) {
                commentField.classList.add('is-invalid'); // –ö–ª–∞—Å—Å Bootstrap (–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞)
            } else {
                commentField.classList.remove('is-invalid');
            }
        } else {
            // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∂–µ–ª–∞—Ç–µ–ª–µ–Ω, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ù–∞—Ä—É—à–µ–Ω–∏–µ)
            // –ù–æ –≤ —Ç–≤–æ–µ–º –¢–ó "–ø–æ–∑–≤–æ–ª—è–µ–º –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ"
            commentField.required = false;
            commentField.placeholder = "–û–ø–∏—à–∏—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ...";
            commentField.classList.remove('is-invalid');
        }
    }


    // === –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê (–≤—ã–∑—ã–≤–∞–µ—Ç updateItemState) ===
    function uploadPhoto(inputElement, itemId) {
        const files = inputElement.files;
        if (files.length === 0) return;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('photos', files[i]);
        }

        const url = `/api/upload-photo/${itemId}/`;

        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                const container = document.getElementById(`photo-container-${itemId}`);
                data.photos.forEach(photo => {
                    const html = `
                        <div class="position-relative photo-wrapper" id="photo-wrapper-${photo.id}">
                            <a href="${photo.url}" target="_blank">
                                <img src="${photo.url}" style="height: 80px; width: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd;">
                            </a>
                            <button type="button"
                                    class="btn position-absolute top-0 end-0 m-1 p-0 border-0 bg-transparent"
                                    onclick="deletePhoto(${photo.id}, ${itemId})">
                                <i class="bi bi-trash-fill text-danger" style="font-size: 18px; text-shadow: 0 0 3px rgba(255,255,255, 0.9);"></i>
                            </button>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

                // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –û–ö)
                updateItemState(itemId);

                inputElement.value = '';
            }
        });
    }

    // === –û–ë–ù–û–í–õ–ï–ù–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç itemId –∏ –≤—ã–∑—ã–≤–∞–µ—Ç updateItemState) ===
    function deletePhoto(photoId, itemId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ?')) return;

        const url = `/api/delete-photo/${photoId}/`;

        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken}
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                const wrapper = document.getElementById(`photo-wrapper-${photoId}`);
                if (wrapper) wrapper.remove();

                // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –û–ö, –µ—Å–ª–∏ —Ñ–æ—Ç–æ –∫–æ–Ω—á–∏–ª–∏—Å—å)
                updateItemState(itemId);
            }
        });
    }

    // === –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø ===
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è –∏ –≤–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "blur" (–ø–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞)
    document.addEventListener("DOMContentLoaded", function() {
        const textAreas = document.querySelectorAll('textarea[name^="comment_"]');

        textAreas.forEach(area => {
            area.addEventListener('blur', function() {
                // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                saveCommentAjax(this);
            });
        });

        // ... —Ç–≤–æ–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ ...
    });

    function saveCommentAjax(textarea) {
        const itemId = textarea.id.split('_')[1];
        const text = textarea.value;
        const url = `/api/save-comment/${itemId}/`; // –ù–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç URL

        const formData = new FormData();
        formData.append('comment', text);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Ñ–æ–Ω–µ
        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        }).then(response => {
            if (response.ok) {
                console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                textarea.style.borderColor = "#198754"; // –ó–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞ - —É—Å–ø–µ—Ö
                setTimeout(() => textarea.style.borderColor = "", 1000);
            }
        });
    }

    // === –ë–õ–û–ö –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===
    // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    document.addEventListener("DOMContentLoaded", function() {
        // 1. –ò—â–µ–º –≤—Å–µ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ "–û–ö", —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ ID –≤–æ–ø—Ä–æ—Å–æ–≤ –µ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        // (–û–Ω–∏ –∏–º–µ—é—Ç id –≤–∏–¥–∞ "radio_ok_15", "radio_ok_23" –∏ —Ç.–¥.)
        const allOkButtons = document.querySelectorAll('[id^="radio_ok_"]');

        allOkButtons.forEach(btn => {
            // 2. –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º ID –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "radio_ok_15" -> "15")
            const itemId = btn.id.split('_')[2];

            // 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è
            updateItemState(itemId);
        });
    });

    // === –ó–ê–©–ò–¢–ê –û–¢ –û–¢–ü–†–ê–í–ö–ò –ù–ï–í–ê–õ–ò–î–ù–û–ô –§–û–†–ú–´ ===
    document.getElementById('inspectionForm').addEventListener('submit', function(event) {
        // –ò—â–µ–º –≤—Å–µ –ø–æ–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ invalid (–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã—à–µ)
        const invalidFields = document.querySelectorAll('textarea.is-invalid');

        if (invalidFields.length > 0) {
            // –û—Ç–º–µ–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
            event.preventDefault();

            // –°–∫—Ä–æ–ª–ª–∏–º –∫ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
            invalidFields[0].scrollIntoView({behavior: "smooth", block: "center"});
            invalidFields[0].focus();

            alert("–û—à–∏–±–∫–∞! –ï—Å–ª–∏ –≤—ã –ø—Ä–∏–∫—Ä–µ–ø–∏–ª–∏ —Ñ–æ—Ç–æ, –≤—ã –û–ë–Ø–ó–ê–ù–´ –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è.");
        }
    });
</script>
</body>
</html>
